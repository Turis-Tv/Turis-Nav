<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Turis Nav</title>
    <style>
        /* --- BASIS & LAYOUT --- */
        @keyframes gradientAnimation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        body, html {
            margin: 0; padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #f0f0f0;
            background: linear-gradient(-45deg, #1d2b64, #2c3e50, #485563, #29323c);
            background-size: 400% 400%; animation: gradientAnimation 15s ease infinite;
            height: 100vh; box-sizing: border-box; 
            overflow: hidden; /* Houdt de body vast */
        }
        h1, h2 {
            font-weight: 600; color: #fff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 4px; margin-bottom: 10px;
            font-size: 16px;
        }
        h2 { font-size: 14px; margin-top: 15px; }

        .input-group {
            display: flex; flex-direction: column;
            gap: 5px; margin-bottom: 8px;
        }
        .input-field {
            width: 100%; padding: 10px;
            border: 1px solid #4a5568; border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.2);
            color: #fff; font-size: 13px; box-sizing: border-box;
        }
        
        .button-group {
            display: flex; gap: 8px; margin-bottom: 10px;
            align-items: flex-start;
        }
        .action-button {
            width: auto; padding: 6px 12px;
            background-image: linear-gradient(to right, #38ef7d, #11998e);
            color: #fff; border: none; border-radius: 6px;
            cursor: pointer; font-size: 12px; font-weight: bold;
            flex-grow: 0; flex-shrink: 0;
        }
        .logout-button {
            background: #c0392b; color: white;
            border: none; border-radius: 6px;
            font-size: 12px; font-weight: bold;
            cursor: pointer; padding: 6px 12px;
            margin-left: 0; flex-grow: 0; flex-shrink: 0;
        }

        #adminContainer { height: calc(100vh - 20px); }
        
        /* CORRECTIE CSS: Zorgt dat de container de ruimte vult en de inhoud verticaal verdeelt */
        #mainView, #exportView {
            display: none; 
            flex-direction: column; 
            height: 100%;
        }
        
        /* De UL's moeten de overgebleven ruimte innemen en scrollen */
        #addressList, #exportList {
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 5px;
        }
        
        /* NIEUW: Stijl voor het verslepen */
        .address-item { cursor: grab; }
        .address-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #2980b9; }


        /* --- LOGIN / LANDING SCHERM (mooi design) --- */
        #loginView {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            margin: -10px;
        }
        .login-panel {
            width: 100%;
            max-width: 360px;
            background: linear-gradient(145deg, rgba(15,32,39,0.96), rgba(32,58,67,0.98));
            border-radius: 24px;
            padding: 24px 20px 18px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            gap: 18px;
            text-align: left;
        }
        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: #38ef7d;
            text-align: center;
            margin: 0 0 4px;
        }
        .app-subtitle {
            font-size: 14px;
            color: #e2e8f0;
            text-align: center;
            margin: 0 0 10px;
        }
        .login-panel hr {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.15);
            margin: 0 0 14px;
        }

        .role-button {
            background: rgba(15,23,42,0.9);
            border-radius: 18px;
            padding: 12px 14px;
            border: 1px solid rgba(72,187,255,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: #fff;
            transition:
                transform .12s ease,
                box-shadow .12s ease,
                border-color .12s ease,
                background .12s ease;
        }
        .role-button.admin {
            border-left: 4px solid #38ef7d;
        }
        .role-button.driver {
            border-left: 4px solid #2791ff;
        }
        .role-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .role-icon {
            width: 32px; height: 32px;
            border-radius: 12px;
            background: rgba(15,23,42,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .role-icon svg {
            width: 18px; height: 18px;
            fill: #ffffff;
        }
        .role-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .role-title {
            font-size: 16px;
            font-weight: 600;
        }
        .role-subtitle {
            font-size: 12px;
            color: #cbd5f5;
        }
        .role-arrow {
            font-size: 18px;
            opacity: 0.9;
        }
        .role-button:hover {
            background: rgba(24,39,72,0.98);
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.45);
        }
        .role-button:active {
            transform: scale(.97);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }
        .landing-footer {
            margin-top: 6px;
            text-align: center;
            font-size: 12px;
            color: #a0aec0;
        }
        
        /* --- LIJSTEN & ITEMS --- */
        #addressList, #exportList { list-style: none; padding: 0; margin: 0; }
        .address-item, .export-item { position: relative; }
        .address-item {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 8px; padding: 10px; margin-bottom: 7px;
            min-height: 80px;
        }
        /* NIEUW: De items in de admin lijst zijn de handles om te verslepen (voor delay) */
        #mainView .address-item { 
            cursor: move; /* Geeft visuele hint dat het versleepbaar is */
        }

        .item-content { cursor: pointer; padding-right: 60px; }
        .name-text { font-size: 15px; font-weight: bold; color: #fff; display: block; margin-bottom: 2px; }
        .address-text { font-size: 12px; color: #e0e0e0; word-wrap: break-word; }
        .edit-delete-controls {
            position: absolute; top: 10px; right: 10px;
            display: flex; gap: 12px;
        }
        .edit-btn, .delete-btn {
            background: none; border: none; padding: 0;
            cursor: pointer; font-size: 14px;
        }
        .delete-btn { color: #ff6b6b; }
        
        @keyframes flash { 0%, 49%{opacity:1;} 50%, 100%{opacity:0.3;} }
        .route-btn {
            padding: 5px 8px; border: none; border-radius: 5px;
            color: #fff; cursor: pointer; font-size: 10px;
            font-weight: bold; background-color: #3398db;
        }
        .address-item .route-btn { position: absolute; bottom: 10px; right: 10px; }
        .export-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 12px; border-radius: 8px;
            margin-bottom: 8px; cursor: pointer;
            transition: background-color .2s;
        }
        .export-item:active { background-color: rgba(255, 255, 255, 0.15); }
        .export-item .route-btn {
            position: absolute; bottom: 8px; right: 8px;
            animation: flash 1s infinite;
        }
        .export-item-header {
            display: flex; justify-content: space-between;
            align-items: baseline; margin-bottom: 4px;
        }
        .export-item-header strong {
            color: #fff; font-size: 15px; font-weight: 600;
        }
        .export-item-address {
            font-size: 12px; line-height: 1.4;
            color: #e0e0e0; margin: 0;
        }
        
        .refresh-button {
            background-color: #34495e; color: white;
            border: none; border-radius: 6px;
            padding: 8px 15px; font-size: 14px;
            cursor: pointer;
        }
        .back-button {
            padding: 8px 15px; background-color: #718096;
            color: #fff; border: none; border-radius: 6px;
            font-size: 14px;
        }
        @keyframes rainbowBorder {
            0%, 100% { border-color: #ff2a6d; }
            25% { border-color: #05d9e8; }
            50% { border-color: #71ff47; }
            75% { border-color: #ffda47; }
        }
        .view-list-button {
            flex-grow: 1; padding: 6px; margin: 0;
            background: transparent; border: 2px solid;
            border-radius: 6px; color: #fff; font-size: 12px;
            font-weight: bold; cursor: pointer;
            animation: rainbowBorder 4s linear infinite;
        }
        @keyframes rainbowText {
            0%, 100% { color: #ffadad; }
            25% { color: #c2ffad; }
            50% { color: #ade9ff; }
            75% { color: #e1adff; }
        }
        .note-text {
            font-size: 11px; margin-top: 4px;
            font-style: italic; animation: rainbowText 6s linear infinite;
        }
        .date-text {
            color: #a0aec0; font-size: 10px;
            font-style: italic; margin-top: 4px; white-space: nowrap;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; padding: 15px; box-sizing: border-box;
        }
        .modal-content {
            background: rgba(44, 62, 80, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 20px; border-radius: 16px;
            width: 100%; max-width: 320px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            text-align: center; position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 8px; right: 8px;
            background: none; border: none;
            color: #bdc3c7; font-size: 20px;
            cursor: pointer; padding: 5px; line-height: 1;
        }
        .modal-content h3 {
            margin-top: 5px; font-size: 16px;
            color: #ecf0f1; font-weight: 500;
        }
        .modal-content p {
            font-size: 14px; color: #fff;
            margin-bottom: 20px; font-weight: normal;
            word-wrap: break-word;
        }
        .modal-actions {
            display: flex; justify-content: space-around; gap: 10px;
        }
        .modal-icon-btn {
            background: none; border: none;
            cursor: pointer; color: #ecf0f1;
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
            padding: 10px; border-radius: 10px;
            transition: transform .2s, background-color .2s;
        }
        .modal-icon-btn:active { transform: scale(.9); }
        .modal-icon-btn svg {
            width: 50px; height: 50px;
        }
        .modal-icon-btn span {
            font-size: 12px; font-weight: 500;
        }
        .modal-action-button {
            flex: 1; padding: 10px; border: none;
            border-radius: 8px; font-size: 14px;
            font-weight: bold; cursor: pointer;
        }
        .confirm-btn { background-color: #e74c3c; color: white; }
        .cancel-btn { background-color: #7f8c8d; color: white; }
        
        .custom-filter-button {
            flex-grow: 1; padding: 10px;
            border: 1px solid #4a5568; border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.2);
            color: #fff; font-size: 13px;
            text-align: left; position: relative; cursor: pointer;
        }
        .custom-filter-button::after {
            content: '‚ñº'; font-size: 10px; color: #bdc3c7;
            position: absolute; right: 12px; top: 50%;
            transform: translateY(-50%);
        }
        #filterModal .modal-content { padding: 10px; }
        #filterOptionsList { max-height: 60vh; overflow-y: auto; }
        .filter-option {
            padding: 12px; border-radius: 6px;
            font-size: 15px; cursor: pointer;
            display: flex; justify-content: space-between;
            align-items: center;
        }
        .filter-option:hover { background-color: rgba(255, 255, 255, 0.1); }
        .filter-option.selected { background-color: rgba(255, 255, 255, 0.15); }
        .filter-option .checkmark {
            font-size: 20px; color: #38ef7d; display: none;
        }
        .filter-option.selected .checkmark { display: inline; }
        
        /* --- PIN PAD MODAL --- */
        #pinPadModal .modal-content { 
            background: rgba(44, 62, 80, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            width: 100%; max-width: 280px; 
            padding: 15px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            margin: 0;
        }
        
        #pinDisplay { 
            background-color: rgba(0,0,0,0.2); 
            border: 1px solid #4a5568; border-radius: 50px; 
            padding: 10px 20px; height: 30px; 
            letter-spacing: 0.5em; font-size: 20px; 
            color: #fff; text-align: center; 
            margin-bottom: 20px; transition: transform 0.1s; 
        }
        
        #pinDisplay.shake { animation: shake 0.4s; }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }

        .pin-grid { 
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            justify-items: center; /* nummers gecentreerd */
        }
        
        .pin-button { 
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.3); 
            background-color: rgba(255,255,255,0.1); 
            color: #fff; font-size: 22px; 
            cursor: pointer; transition: background-color 0.2s; 
            backdrop-filter: blur(2px); 
        }
        .pin-button:active { background-color: rgba(255,255,255,0.3); }
        .pin-button.icon { font-size: 20px; }
        
        /* --- MOBIELE PIN PAD --- */
        @media (max-width: 600px) {
            #pinPadModal .modal-content {
                max-width: 90vw;
                padding: 15px; margin: 0;
            }
            #pinDisplay {
                font-size: 18px; height: 25px;
                padding: 8px 15px; margin-bottom: 20px;
                letter-spacing: 0.3em;
            }
            .pin-grid { gap: 12px; }
            .pin-button {
                width: 55px; height: 55px; font-size: 22px;
            }
            .pin-button.icon { font-size: 18px; }
            #pinPadModal .modal-content h3 {
                font-size: 15px; margin-bottom: 15px;
            }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            #pinPadModal .modal-content {
                max-width: 95vw; padding: 10px;
                max-height: 95vh; overflow-y: auto;
            }
            #pinDisplay {
                font-size: 16px; height: 20px;
                padding: 6px 12px; margin-bottom: 15px;
                letter-spacing: 0.2em;
            }
            .pin-grid {
                gap: 8px;
                grid-template-columns: repeat(4, 1fr);
            }
            .pin-button {
                width: 45px; height: 45px; font-size: 18px;
            }
            .pin-button.icon { font-size: 16px; }
            #pinPadModal .modal-content h3 {
                font-size: 14px; margin-bottom: 10px;
            }
        }
        @media (max-width: 350px) {
            .pin-button {
                width: 50px; height: 50px; font-size: 20px;
            }
            .pin-grid { gap: 10px; }
        }
    </style>
</head>
<body>
    <!-- De HTML is exact hetzelfde gebleven -->
    <div id="loginView">
        <div class="login-panel">

   
            <button class="role-button admin" onclick="showPinPad()">
                <div class="role-main">
                    <div class="role-icon">
                        <svg viewBox="0 0 24 24"><path d="M19.14...z"></path></svg>
                    </div>
                    <div class="role-text">
                        <div class="role-title">Admin</div>
                        <div class="role-subtitle">Giri≈üi</div>
                    </div>
                </div>
                <div class="role-arrow">‚ûú</div>
            </button>
            <button class="role-button driver" onclick="loginAsGuest()">
                <div class="role-main">
                    <div class="role-icon">
                        <svg viewBox="0 0 24 24"><path d="M18.92...z"></path></svg>
                    </div>
                    <div class="role-text">
                        <div class="role-title">≈ûof√∂rler</div>
                        <div class="role-subtitle">Giri≈üi</div>
                    </div>
                </div>
                <div class="role-arrow">‚ûú</div>
            </button>
  
        </div>
    </div>

    <div id="adminContainer" style="display: none;">
        <div id="mainView">
  
            <div class="input-group">
                <input type="text" id="nameInput" class="input-field" placeholder="ƒ∞sim (zorunlu)">
                <input type="text" id="addressInput" class="input-field" placeholder="Adres (zorunlu)">
            </div>
            <div class="button-group">
                <button class="action-button" onclick="saveItem()">Kayƒ±t</button>
                <button class="view-list-button" onclick="showExportView()">Liste</button>
                <button class="logout-button" onclick="logout()">Admin</button>
            </div>
            <!-- NIEUW: Titel voor de gesorteerde lijst is hier geplaatst -->

            <ul id="addressList"></ul>
        </div>

        <div id="exportView">
            <div style="display: flex; justify-content: space-between; align-items: center;">
    
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="refresh-button" onclick="renderAllLists()">üîÑ Yenile</button>
                    <button id="guestLogoutBtn" class="logout-button" style="display: none;" onclick="logout()">√áƒ±kƒ±≈ü yap</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="backButton" class="back-button" style="margin:0;"></button>
                <button id="customFilterBtn" class="custom-filter-button" onclick="openFilterModal()">T√ºm ƒ∞simler</button>
            </div>
            <ul id="exportList"></ul>
        </div>
    </div>

    <div id="errorModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn" onclick="closeErrorModal()">√ó</button>
            <h3 id="error-title"></h3>
            <p id="error-message"></p>
            <button class="action-button" style="width:100%;" onclick="closeErrorModal()">OK</button>
        </div>
    </div>

    <div id="navigationModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn" onclick="closeNavigationModal()">√ó</button>
            <h3>≈ûuraya gidin:</h3>
            <p id="modal-address-text"></p>
            <div id="modal-actions-container" class="modal-actions"></div>
        </div>
    </div>

    <div id="filterModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-bottom: 10px;">ƒ∞sme G√∂re Filtrele</h3>
            <div id="filterOptionsList"></div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="confirmation-title">Onay</h3>
            <p id="confirmation-message"></p>
            <div class="modal-actions">
                <button id="cancel-btn" class="modal-action-button cancel-btn">‚Ü© ƒ∞ptal</button>
                <button id="confirm-btn" class="modal-action-button confirm-btn">Sil</button>
            </div>
        </div>
    </div>
    
    <div id="pinPadModal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-bottom: 20px;">≈ûifre Girin</h3>
            <div id="pinDisplay"></div>
            <div class="pin-grid">
                <button class="pin-button" onclick="appendToPin('1')">1</button>
                <button class="pin-button" onclick="appendToPin('2')">2</button>
                <button class="pin-button" onclick="appendToPin('3')">3</button>
                <button class="pin-button" onclick="appendToPin('4')">4</button>
                <button class="pin-button" onclick="appendToPin('5')">5</button>
                <button class="pin-button" onclick="appendToPin('6')">6</button>
                <button class="pin-button" onclick="appendToPin('7')">7</button>
                <button class="pin-button" onclick="appendToPin('8')">8</button>
                <button class="pin-button" onclick="appendToPin('9')">9</button>
                <button class="pin-button" onclick="closePinPad()">‚Ü© </button>
                <button class="pin-button" onclick="appendToPin('0')">0</button>
                <button class="pin-button icon" onclick="deleteFromPin()">‚å´</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYOutcxpBRRQ3MEOVZiLL-lI2L1A8uWvs",
            authDomain: "turisnavapp.firebaseapp.com",
            databaseURL: "https://turisnavapp-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "turisnavapp",
            storageBucket: "turisnavapp",
            messagingSenderId: "238654300870",
            appId: "1:238654300870:web:6e09d6b353df94d0e8adc7",
            measurementId: "G-7WFC0S7XRR"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const itemsRef = database.ref('addresses');
        const ADMIN_PASSWORD = '6636';
        let currentFilterValue = 'all';
        let allItems = [];
        let enteredPin = '';
        let sortableInstance = null; 

        itemsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            allItems = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    allItems.push({ id: key, ...data[key] });
                });
            }
            
            // Sorteer de lijst op basis van 'sortOrder'. 
            allItems.sort((a, b) => {
                const orderA = a.sortOrder === undefined || a.sortOrder === null ? Infinity : a.sortOrder;
                const orderB = b.sortOrder === undefined || b.sortOrder === null ? Infinity : b.sortOrder;
                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                return (b.createdAt || 0) - (a.createdAt || 0); 
            });

            if (sessionStorage.getItem('userRole') === 'guest' &&
                snapshot.numChildren() > (window.lastItemCount || 0)) {
                if (window.lastItemCount !== undefined) { playBeep(); }
            }
            window.lastItemCount = snapshot.numChildren();
            renderAllLists();
        });

        function renderAllLists() {
            if (document.getElementById('mainView').style.display === 'flex') { renderAdminList(); }
            if (document.getElementById('exportView').style.display === 'flex') { renderFilteredList(); updateFilterOptions(); }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'admin') { loginAsAdmin(); } 
            else if (userRole === 'guest') { loginAsGuest(); } 
            else {
                document.getElementById('loginView').style.display = 'flex';
                document.getElementById('adminContainer').style.display = 'none';
            }
        });

        function saveItem() {
            const name = document.getElementById('nameInput').value.trim();
            const address = document.getElementById('addressInput').value.trim();
            if (!address) { showErrorModal('Hata !!!', 'Adres alanƒ± zorunludur.'); return; }

            const today = new Date();
            const formattedDate =
                `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`;

            itemsRef.push({
                name,
                address,
                note: '',
                date: formattedDate,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                sortOrder: Date.now() 
            });

            document.getElementById('nameInput').value = '';
            document.getElementById('addressInput').value = '';
            document.getElementById('nameInput').focus();
        }

        function deleteItem(id) {
            showConfirmationModal('Bu √∂ƒüeyi silmek istediƒüinizden emin misiniz?', () => {
                database.ref('addresses/' + id).remove();
            });
        }

        function startEdit(id) {
            const item = allItems.find(i => i.id === id); if (!item) return;
            const listItem = document.getElementById(`item-${id}`); if (!listItem) return;

            listItem.innerHTML =
                `<div class="item-content" style="width: 100%; margin-top:0;">
                    <input type="text" value="${item.name || ''}" class="input-field edit-name-input" placeholder="ƒ∞sim">
                    <input type="text" value="${item.address}" class="input-field edit-address-input" placeholder="Adres (zorunlu)">
                    <input type="text" value="${item.note || ''}" class="input-field edit-note-input" placeholder="Not">
                    <input type="text" value="${item.date || ''}" class="input-field edit-date-input" placeholder="Tarih">
                    <input type="number" value="${item.sortOrder === undefined || item.sortOrder === null ? '' : item.sortOrder}" class="input-field edit-sort-order-input" placeholder="Sorteer Nr. (optioneel)">
                </div>
                <div class="controls-wrapper" style="min-height: auto; justify-content: flex-start; flex-direction: row; gap: 5px;">
                    <button onclick="saveEdit('${id}')" class="action-button" style="width:auto;padding:8px 12px;margin:0;">‚úì</button>
                    <button onclick="renderAdminList()" class="back-button" style="width:auto;padding:8px 12px;margin:0;">‚úó</button>
                </div>`;

            listItem.querySelector('.edit-address-input').focus();
        }

        function saveEdit(id) {
            const newName = document.querySelector(`#item-${id} .edit-name-input`).value.trim();
            const newAddress = document.querySelector(`#item-${id} .edit-address-input`).value.trim();
            const newNote = document.querySelector(`#item-${id} .edit-note-input`).value.trim();
            const newDate = document.querySelector(`#item-${id} .edit-date-input`).value.trim();
            
            const sortOrderInput = document.querySelector(`#item-${id} .edit-sort-order-input`).value;
            const newSortOrder = sortOrderInput === '' ? null : parseInt(sortOrderInput, 10);
            
            if (!newAddress) { showErrorModal('Hata !!!', 'Adres alanƒ± zorunludur.'); return; }

            database.ref('addresses/' + id).update({
                name: newName, address: newAddress, note: newNote, date: newDate, sortOrder: newSortOrder
            });
        }

        function renderAdminList() {
            const list = document.getElementById('addressList'); 
            list.innerHTML = '';
            
            allItems.forEach(item => {
                const li = document.createElement('li'); 
                li.className = 'address-item'; 
                li.id = `item-${item.id}`;
                li.dataset.id = item.id; 

                const noteHTML = item.note ? `<div class="note-text">${item.note}</div>` : '';
                const dateHTML = item.date ? `<div class="date-text">${item.date}</div>` : '';
                
                li.innerHTML =
                    `<div class="item-content" onclick="openNavigationModal('${item.id}')">
                        <div class="name-text">${item.name || '(ƒ∞simsiz)'}</div>
                        <div class="address-text">${item.address}</div>
                        ${noteHTML}${dateHTML}
                    </div>
                    <div class="edit-delete-controls">
                        <button class="edit-btn" onclick="event.stopPropagation(); startEdit('${item.id}')">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteItem('${item.id}')">üóëÔ∏è</button>
                    </div>
                    <button class="route-btn" onclick="event.stopPropagation(); openNavigationModal('${item.id}');">Route</button>`;
                list.appendChild(li);
            });
            // Initialisatie van Sortable na het renderen van de lijst
            initializeSortable(); 
        }

        function renderFilteredList() {
            const filtered = currentFilterValue === 'all'
                ? allItems
                : allItems.filter(item => item.name === currentFilterValue);

            const list = document.getElementById('exportList'); list.innerHTML = '';
            if (filtered.length === 0) {
                list.innerHTML = '<li style="text-align:center;color:#a0aec0;padding:20px;">Bu filtre i√ßin adres yok.</li>';
                return;
            }

            filtered.forEach(item => {
                const li = document.createElement('li'); li.className = 'export-item'; li.onclick = () => openNavigationModal(item.id);
                const noteHTML = item.note ? `<div class="note-text">${item.note}</div>` : '';
                const dateHTML = item.date ? `<span class="date-text">${item.date}</span>` : '';
                li.innerHTML =
                    `<button class="route-btn" onclick="event.stopPropagation(); openNavigationModal('${item.id}');">Route</button>
                     <div class="export-item-header">
                        <strong>${item.name || '(ƒ∞simsiz)'}</strong>${dateHTML}
                     </div>
                     <p class="export-item-address">${item.address}</p>
                     ${noteHTML}`;
                list.appendChild(li);
            });
        }

        function loginAsAdmin() {
            sessionStorage.setItem('userRole', 'admin');
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            document.getElementById('guestLogoutBtn').style.display = 'none';
            showMainView();
        }

        function loginAsGuest() {
            sessionStorage.setItem('userRole', 'guest');
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            document.getElementById('guestLogoutBtn').style.display = 'inline-block';
            document.getElementById('backButton').style.display = 'none';
            showExportView();
        }
        
        function logout() {
            sessionStorage.removeItem('userRole');
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }

        function showMainView() {
            document.getElementById('exportView').style.display = 'none';
            document.getElementById('mainView').style.display = 'flex';
            renderAdminList();
        }
        
        function initializeSortable() {
            if (sortableInstance) {
                sortableInstance.destroy(); 
            }
            const listElement = document.getElementById('addressList');
            if (listElement) {
                 sortableInstance = new Sortable(listElement, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    delay: 200, // NIEUW: Houd 200ms ingedrukt voordat verslepen begint
                    touchStartThreshold: 5, // NIEUW: Zorgt voor betere detectie op touchscreens
                    handle: ".address-item", // NIEUW: Het hele item is het drag-element
                    onEnd: function (evt) {
                        const items = listElement.children;
                        const updates = {};
                        for (let i = 0; i < items.length; i++) {
                            const itemId = items[i].dataset.id;
                            // Sla de index (i) op als de nieuwe sortOrder
                            updates[`/addresses/${itemId}/sortOrder`] = i;
                        }
                        database.ref().update(updates);
                    }
                });
            }
        }

        function showExportView() {
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('exportView').style.display = 'flex';

            const backBtn = document.getElementById('backButton');
            if (sessionStorage.getItem('userRole') === 'admin') {
                backBtn.textContent = '‚Äπ‚Äπ‚Äπ';
                backBtn.onclick = showMainView;
                backBtn.style.display = 'inline-block';
            } else {
                backBtn.style.display = 'none';
            }

            currentFilterValue = 'all';
            document.getElementById('customFilterBtn').textContent = 'T√ºm ƒ∞simler';
            renderFilteredList();
        }

        /* PIN PAD */
        const pinDisplay = document.getElementById('pinDisplay');

        function showPinPad() { 
            document.getElementById('pinPadModal').style.display = 'flex'; 
            enteredPin = ''; pinDisplay.textContent = '';
        }
        function closePinPad() {
            document.getElementById('pinPadModal').style.display = 'none';
            enteredPin = ''; pinDisplay.textContent = '';
        }

        function appendToPin(num) {
            if (enteredPin.length < 4) {
                enteredPin += num;
                pinDisplay.textContent = '‚Ä¢'.repeat(enteredPin.length);
                if (enteredPin.length === 4) { checkPin(); }
            }
        }

        function deleteFromPin() {
            enteredPin = enteredPin.slice(0, -1);
            pinDisplay.textContent = '‚Ä¢'.repeat(enteredPin.length);
        }

        function checkPin() {
            if (enteredPin === ADMIN_PASSWORD) {
                setTimeout(() => { closePinPad(); loginAsAdmin(); }, 200);
            } else {
                pinDisplay.classList.add('shake');
                setTimeout(() => {
                    pinDisplay.classList.remove('shake');
                    enteredPin = '';
                    pinDisplay.textContent = '';
                }, 500);
            }
        }
        
        function showErrorModal(title, message) {
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }
        document.getElementById('errorModal').addEventListener('click', closeErrorModal);
        
        function showConfirmationModal(message, onConfirmCallback) {
            const modal = document.getElementById('confirmationModal');
            modal.querySelector('#confirmation-message').textContent = message;
            const confirmBtn = modal.querySelector('#confirm-btn');
            const cancelBtn = modal.querySelector('#cancel-btn');

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                onConfirmCallback();
                closeConfirmationModal();
            };
            cancelBtn.onclick = closeConfirmationModal;

            modal.onclick = (e) => { if (e.target === modal) closeConfirmationModal(); };
            modal.style.display = 'flex';
        }
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        function openNavigationModal(id) {
            const item = allItems.find(i => i.id === id); if (!item) return;
            document.getElementById('modal-address-text').textContent = item.address;

            const safeAddr = item.address.replace(/'/g, "\\'");
            const wazeSVG = `
                <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="32" cy="32" r="28"
                        fill="rgba(255,255,255,0.08)"
                        stroke="#ffffff" stroke-width="2"></circle>
                    <path d="M18 34c1.5 6 6.5 10 13.5 10 7.2 0 13-4.4 13.5-12.5C45.5 21 38 18 31 18 23 18 18 22.5 18 30v4z"
                        fill="#ffffff" opacity="0.98"></path>
                    <circle cx="26" cy="29" r="1.7" fill="#1f2933"></circle>
                    <circle cx="34" cy="29" r="1.7" fill="#1f2933"></circle>
                    <path d="M25 34c1.5 1.6 3.5 2.4 6 2.4 2.4 0 4.4-.8 5.9-2.4"
                        fill="none" stroke="#1f2933" stroke-width="1.4" stroke-linecap="round"></path>
                </svg>`;
            const mapsSVG = `
                <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="32" cy="32" r="28"
                        fill="rgba(255,255,255,0.08)"
                        stroke="#ffffff" stroke-width="2"></circle>
                    <path d="M32 17c-6.1 0-11 4.8-11 10.9 0 7.5 7.3 14.9 10.2 18 0.5 0.5 1.3 0.5 1.8 0 2.9-3.1 10.2-10.5 10.2-18C43.2 21.8 38.2 17 32 17z"
                        fill="#ffffff" opacity="0.98"></path>
                    <circle cx="32" cy="28" r="3.3" fill="#1f2933"></circle>
                </svg>`;

            const wazeButtonHTML =
                `<button class="modal-icon-btn" onclick="navigate('${safeAddr}', 'waze')">
                    ${wazeSVG}<span>Waze</span>
                 </button>`;
            const mapsButtonHTML =
                `<button class="modal-icon-btn" onclick="navigate('${safeAddr}', 'maps')">
                    ${mapsSVG}<span>Maps</span>
                 </button>`;

            document.getElementById('modal-actions-container').innerHTML =
                wazeButtonHTML + mapsButtonHTML;

            document.getElementById('navigationModal').style.display = 'flex';
        }

        function closeNavigationModal() {
            document.getElementById('navigationModal').style.display = 'none';
        }
        document.getElementById('navigationModal').addEventListener('click', closeNavigationModal);

        function navigate(address, app) {
            const enc = encodeURIComponent(address),
                  url = app === 'waze'
                    ? `intent://?q=${enc}&navigate=yes#Intent;package=com.waze;scheme=waze;end`
                    : `https://www.google.com/maps/search/?api=1&query=${enc}`;
            window.open(url, '_system') || window.open(url, '_blank');
            closeNavigationModal();
        }

        function openFilterModal() {
            updateFilterOptions();
            document.getElementById('filterModal').style.display = 'flex';
        }

        function updateFilterOptions() {
            const names = [...new Set(allItems.map(i => i.name).filter(Boolean))]
                .sort((a, b) => a.localeCompare(b, 'tr'));
            const list = document.getElementById('filterOptionsList');
            list.innerHTML = '';
            const add = (val, txt) => {
                const opt = document.createElement('div');
                opt.className = 'filter-option' +
                    (currentFilterValue === val ? ' selected' : '');
                opt.innerHTML = `<span>${txt}</span><span class="checkmark">‚úì</span>`;
                opt.onclick = (e) => { e.stopPropagation(); selectFilter(val); };
                list.appendChild(opt);
            };
            add('all', 'T√ºm ƒ∞simler');
            names.forEach(n => add(n, n));
        }

        function selectFilter(val) {
            currentFilterValue = val;
            document.getElementById('customFilterBtn').textContent =
                val === 'all' ? 'T√ºm ƒ∞simler' : val;
            closeFilterModal();
            renderFilteredList();
        }

        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }
        document.getElementById('filterModal').addEventListener('click', closeFilterModal);

        function playBeep() {
            try {
                const a = new (window.AudioContext || window.webkitAudioContext)(),
                      o = a.createOscillator(),
                      g = a.createGain();
                o.connect(g);
                g.connect(a.destination);
                o.type = 'sine';
                o.frequency.setValueAtTime(880, a.currentTime);
                g.gain.setValueAtTime(0, a.currentTime);
                g.gain.linearRampToValueAtTime(0.5, a.currentTime + 0.01);
                g.gain.linearRampToValueAtTime(0, a.currentTime + 0.3);
                o.start(a.currentTime);
                o.stop(a.currentTime + 0.3);
            } catch (e) {
                console.warn("Audio API niet beschikbaar.", e);
            }
        }

        window.addEventListener('beforeunload', () => {
            if (sessionStorage.getItem('userRole') === 'guest') {
                sessionStorage.removeItem('userRole');
            }
        });

        document.getElementById('pinPadModal').addEventListener('click', (e) => {
            if (e.target.id === 'pinPadModal') closePinPad();
        });
    </script>
</body>
</html>
